+++
date = "2017-11-27T14:00:00-07:00"
draft = false
title = "Code Quality"
weight = 13

[menu.main]
Name = "Code Quality"
parent = "features"

pre = "The core engine driving code quality checks in Jazz is SonarQube."

+++
<!-- Add a short description in the pre field inside menu

What is a Jazz Service, Namespaces & Environments
================================================== -->

## Overview

Jazz leverages SonarQube for static code scans. SonarQube uses SonarScanner, a command line tool that scans and parses your source code and pushes the scan results to the EDP Cloud's SonarQube service. Developers can use Jazz UI to view these code quality reports for further analysis. Metrics like Code Vulnerabilities, Code Smells, Reliability, Security and Maintainability ratings etc. are available through Sonar Scans.

In order to view reports in SonarQube directly, click `View in SonarQube` link in Jazz UI under `Code Quality` section. You will need Cloud (CORP) account to login. If you don't have one, you can get your CORP account [here](https://access.t-mobile.com/manage).


&nbsp;
## Customizing Sonar Scan

Developers can now customize how their code gets scanned by providing their own `sonar-project.properties` file. For simplicity, Jazz provides a template that they can customize. Following is the list of fields that developers can modify in their `sonar-project.properties` file.

|Key|Sample value|Description|
|:------|:------|:------|
|**sonar.projectVersion**|1.0| Custom project version|
|**sonar.projectName**|MySonarProject | Custom project name. Default value is domain_service name|
|**sonar.sourceEncoding**|UTF-8 | Custom encoding of the source code. Default value is system encoding|
|**sonar.projectDescription**|Test Sonar Project | Custom project description|
|**sonar.sources**|. | Custom path of sub_directory to be analysed. Default value is a dot which means it analyses all directories|
|**sonar.exclusions**|`dist/**,virtualenv/**,venv/**,**/*.json,**/*.spec.js,**/*_test.go,**/vendor/**` | Comma separated file paths to exclude from analysis. By default, it escapes the path provided in sample from analysis|

**Note**: Some of the fields that developers will not be able to override -

- sonar.host.url

- sonar.projectKey

- sonar.login

- sonar.password

You can read [here](https://docs.sonarqube.org/latest/analysis/analysis-parameters/) to know more about the sonar properties.

&nbsp;
## Fortify Code Scan

Along with SonarQube Scan, Jazz also integrates Fortify Scan in its CI/CD pipeline to automatically scan the source for any security issues quickly without installing a 3rd party software.  Fortify scanner runs in parallel with build & deploy workflows. The issues found from analysis will be logged in an issue tracker for further actions and providing fixes. Jazz also surfaces the fortify scan metrics through its UI. 

The below screenshot shows the code quality tab with metrics for one of the environments.

<img src='/content/jazz-features/media/code-quality.png' width='700px'>

&nbsp;

## Code Coverage

### Overview
Code coverage reports are now generated while running unit test cases in the build pipeline. SonarScanner parses these coverage reports and updates the SonarQube server with the metrics. By default, the following code coverage reporters are used:


| Runtime/Framework | Default Coverage Reporter| Description |
|:------|:------|:------|
|**NodeJS 12.x**|Jest| Uses Jest to generate coverage reports. <br> If you would like to use a different testing framework, use npm to install it, <br> and edit the "scrips" section in ```package.json``` in your project's root directory.|
|**Python 3.8**|PyTest and Coverage | The unit tests are run by PyTest and the coverage reports are gathered by Coverage.py |
|**Java 11**|Jacoco | Coverage reports are generated by Jacoco. <br> If you would like to use something else, please modify the "coverage" profile in your project's pom.xml. |
|**GO 1.x**|Go Test | Uses the default test coverage reporter used in Go. |
|**Angular**| Karma | Uses Karma to run unit test cases and generate coverage reports. <br> If you would like to customise the tests, make changes to ```app/src/karma.conf.js``` and ```app/angular.json``` |
|**React**| Jest | Uses the default framework for React. <br> If you would like to change this, you will have to eject your React app. <br> Please read up about it on React's documentation site. |
|**Static HTML**| N/A | N/A |

&nbsp;

### How do I enable code coverage for my existing services?

If you wish to add code coverage to your existing project, follow the steps for your specific runtime below.

&nbsp;

- Java

        1. Add the Jacoco plugin to the plugins section in your pom.xml file:

                <plugin>
                        <groupId>org.jacoco</groupId>
                        <artifactId>jacoco-maven-plugin</artifactId>
                        <version>0.8.6</version>
                </plugin>

        2. Add a "coverage" profile to the profile section in your pom.xml:

                <profiles>
                        <profile>
                                <id>coverage</id>
                                <activation>
                                        <activeByDefault>true</activeByDefault>
                                </activation>
                                <build>
                                        <plugins>
                                                <plugin>
                                                        <groupId>org.jacoco</groupId>
                                                        <artifactId>jacoco-maven-plugin</artifactId>
                                                        <executions>
                                                                <execution>
                                                                        <id>prepare-agent</id>
                                                                        <goals>
                                                                                <goal>prepare-agent</goal>
                                                                        </goals>
                                                                </execution>
                                                                <execution>
                                                                        <id>report</id>
                                                                        <goals>
                                                                                <goal>report</goal>
                                                                        </goals>
                                                                </execution>
                                                        </executions>
                                                </plugin>
                                        </plugins>
                                </build>
                        </profile>
                </profiles>

&nbsp;

- NodeJS

        1. In the scripts section, add:

                        "scripts": {
                                "test": "./node_modules/.bin/jest --coverage"
                        }


        2. In the devDependencies section, add:

                        "devDependencies": {
                                "chai": "^3.5.0",
                                "jest-sonar-reporter": "^2.0.0",
                                "jscover": "^1.0.0"
                        }

        3. Configure Jest:

                        "jest": {
                            "testEnvironment": "node",
                            "collectCoverage": true,
                            "testResultsProcessor": "jest-sonar-reporter",
                            "coveragePathIgnorePatterns": [
                              "/node_modules/",
                              "/test/"
                            ]
                        }

&nbsp;

- Angular

        1. In karma.conf.js, change the browser config:

                        browsers: ['ChromeHeadlessNoSandbox'],
                        customLaunchers: {
                                ChromeHeadlessNoSandbox: {
                                        base: 'ChromeHeadless',
                                        flags: ['--no-sandbox']
                                }
                        }

&nbsp;

- React

        No changes required

&nbsp;

- Python

        No changes required

&nbsp;

- Go

        No changes required

&nbsp;
### Customizing Coverage Report Generation

If you would like to use a different tool to generate code coverage reports, they need to conform to the Cobertura XML format which can be parsed by SonarScanner.

You will also need to specify the location of the generated code coverage reports by specifying the following properties in the ```sonar.properties``` file in your project:

| Runtime | "sonar.properties" property |
|:------|:------|
|**NodeJS 12.x**| sonar.javascript.lcov.reportPaths |
|**Python 3.8**| sonar.python.coverage.reportPaths|
|**Java 11**| sonar.coverage.jacoco.xmlReportPaths |
|**GO 1.x**| sonar.go.coverage.reportPaths |
|**Angular** | sonar.javascript.lcov.reportPaths |
|**React** | sonar.javascript.lcov.reportPaths |
|**Static HTML**| N/A | N/A |

&nbsp;
#### You can view code coverage reports on:

- Jazz UI
        
        Service Dashboard → <service_name> → Click on a deployment environment → Code quality tab → code coverage



- SonarQube Dashboard

        You can log into the SonarQube Dashboar and view the coverge report details there, or follow the link on the code quality tab

&nbsp;

<img src='/content/jazz-features/media/code-coverage.png' width='700px'>
